<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euroleague Fantasy Score Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<main class="container">
    <header>
        <h1>Euroleague Fantasy Score Calculator</h1>
        <p>Calculates fantasy scores for your league teams.</p>
    </header>

    <section id="loading">
        <p>Loading data...</p>
    </section>

    <section id="error" style="display: none; color: #f63a3a;">
        <p id="error-message"></p>
    </section>

    <section id="results" style="display: none;">
        <h2>Team Scores</h2>
        <table role="grid">
            <thead>
            <tr>
                <th>Team ID</th>
                <th>Score</th>
            </tr>
            </thead>
            <tbody id="team-scores">
            </tbody>
        </table>
    </section>

    <footer>
        <small>&copy; 2023 Your Name/Organization</small>
    </footer>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function (event) {
        const teamIDs = [123, 456, 789, 199];
        const matchDay = 123456;
        const baseURL = 'https://fantaking-api.dunkest.com/api/v1';
        const leagueId = 91858;  // Hardcoded league ID

        // Function to fetch data from an API endpoint
        function fetchData(url) {
            return $.getJSON(url)
                .fail(function(jqXHR, textStatus, error) {
                    console.error(`Error fetching data from ${url}:`, textStatus, error);
                    throw new Error(`Failed to fetch data from ${url}: ${textStatus}`);
                });
        }

        // Function to get the matches for a given match day
        function getMatchesForMatchDay(matchDay) {
            const url = `${baseURL}/schedules/15/matchdays/${matchDay}`;
            return fetchData(url);
        }

        // Function to get the lineups for a given match
        function getLineupsForMatch(matchId) {
            const url = `${baseURL}/matches/${matchId}/lineups`;
            return fetchData(url);
        }

        // Function to get the players for a given team
        function getPlayersForTeam(teamId) {
            const url = `${baseURL}/fantasy-leagues/${leagueId}/fantasy-teams/${teamId}`;
            return fetchData(url);
        }

        // Function to calculate team scores
        async function calculateTeamScores() {
            const teamScores = {};

            // Initialize team scores
            teamIDs.forEach(teamId => {
                teamScores[teamId] = 0;
            });

            try {
                // 1. Get Matches for the match day
                const matchData = await getMatchesForMatchDay(matchDay);
                const matches = matchData.data.rounds[0].matches; // Assuming only one round

                // 2. Iterate through matches and get lineups
                for (const match of matches) {
                    const matchId = match.id;
                    const lineupsData = await getLineupsForMatch(matchId);
                    const homeTeamLineups = lineupsData.data.home_team.lineups || [];
                    const awayTeamLineups = lineupsData.data.away_team.lineups || [];

                    // 3. Sum player scores for each team
                    homeTeamLineups.forEach(player => {
                        // Find the team id from the player
                        const teamId = teamIDs.find(teamId => teamId === undefined);
                        teamScores[teamId] += player.pts || 0;
                    });
                    awayTeamLineups.forEach(player => {
                        const teamId = teamIDs.find(teamId => teamId === undefined);
                        teamScores[teamId] += player.pts || 0;
                    });
                }

                return teamScores;

            } catch (error) {
                console.error("Error calculating team scores:", error);
                throw error; // Re-throw to be caught by main
            }
        }

        // Function to display team scores in the table
        function displayTeamScores(teamScores) {
            const tableBody = $('#team-scores');
            tableBody.empty();

            for (const teamId in teamScores) {
                if (teamScores.hasOwnProperty(teamId)) {
                    const score = teamScores[teamId];
                    const row = `<tr><td>${teamId}</td><td>${score.toFixed(2)}</td></tr>`;
                    tableBody.append(row);
                }
            }
        }

        // Main function
        async function main() {
            $('#loading').show();
            $('#error').hide();
            $('#results').hide();

            try {
                const teamScores = await calculateTeamScores();
                displayTeamScores(teamScores);

                $('#loading').hide();
                $('#results').show();
            } catch (error) {
                console.error("Error in main function:", error);
                $('#loading').hide();
                $('#error-message').text("An error occurred: " + error.message);
                $('#error').show();
            }
        }

        // Start the process
        main();
    });
</script>
</body>
</html>
